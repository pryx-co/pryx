---
import Layout from '../layouts/Layout.astro';

const nextParam = Astro.url.searchParams.get('next');
const next = nextParam && nextParam.startsWith('/') && !nextParam.startsWith('//')
    ? nextParam
    : '/dashboard';
---

<Layout title="Sign In | Pryx Cloud">
    <main class="auth-shell">
        <section class="auth-card">
            <h1>Sign In to Pryx Cloud</h1>
            <p>
                Use your API token to access protected routes. Superadmin access is derived from
                superadmin tokens only.
            </p>

            <form id="auth-form">
                <input type="hidden" id="next" value={next} />

                <label for="token">Access Token</label>
                <input id="token" name="token" type="password" required placeholder="user:user-123 or superadmin:<token>" />

                <button type="submit">Sign In</button>
            </form>

            <a class="logout-link" href="/logout">Sign out current session</a>
            <p id="auth-error" class="error" aria-live="polite"></p>
        </section>
    </main>

    <script>
        const form = document.getElementById('auth-form');
        const tokenInput = document.getElementById('token');
        const nextInput = document.getElementById('next');
        const errorOutput = document.getElementById('auth-error');

        function sanitizeClientRedirect(candidate, fallback) {
            if (!candidate || !candidate.startsWith('/') || candidate.startsWith('//')) {
                return fallback;
            }

            try {
                const parsed = new URL(candidate, window.location.origin);
                if (parsed.origin !== window.location.origin) {
                    return fallback;
                }
                return `${parsed.pathname}${parsed.search}${parsed.hash}`;
            } catch {
                return fallback;
            }
        }

        form?.addEventListener('submit', (event) => {
            event.preventDefault();

            const token = tokenInput instanceof HTMLInputElement ? tokenInput.value.trim() : '';
            const nextRoute = nextInput instanceof HTMLInputElement ? nextInput.value : '/dashboard';

            if (!token) {
                if (errorOutput) errorOutput.textContent = 'Token is required.';
                return;
            }

            const isSecure = window.location.protocol === 'https:';
            const secureFlag = isSecure ? '; Secure' : '';
            const isSuperadminToken = token.startsWith('superadmin:') || token === 'localhost';
            const derivedRole = isSuperadminToken ? 'superadmin' : 'user';

            document.cookie = `auth_token=${encodeURIComponent(token)}; Path=/; Max-Age=86400; SameSite=Lax${secureFlag}`;
            document.cookie = `auth_role=${encodeURIComponent(derivedRole)}; Path=/; Max-Age=86400; SameSite=Lax${secureFlag}`;

            const destination = isSuperadminToken
                ? '/superadmin'
                : sanitizeClientRedirect(nextRoute, '/dashboard');
            window.location.href = destination;
        });
    </script>
</Layout>

<style>
    .auth-shell {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 1.5rem;
    }

    .auth-card {
        width: min(32rem, 100%);
        border: 1px solid rgba(147, 197, 253, 0.28);
        border-radius: 1rem;
        padding: 1.5rem;
        background: rgba(8, 20, 28, 0.82);
        font-family: 'Space Grotesk', 'Trebuchet MS', 'Avenir Next', sans-serif;
    }

    h1 {
        margin-top: 0;
        margin-bottom: 0.4rem;
    }

    p {
        margin-top: 0;
        color: #a9c7c5;
    }

    form {
        display: grid;
        gap: 0.7rem;
        margin-top: 1rem;
    }

    label {
        font-size: 0.9rem;
        color: #d7ebe8;
    }

    input,
    select {
        border-radius: 0.6rem;
        border: 1px solid rgba(169, 199, 197, 0.45);
        background: rgba(5, 14, 20, 0.72);
        color: #eff8f6;
        padding: 0.65rem 0.7rem;
    }

    button {
        margin-top: 0.4rem;
        border: 0;
        border-radius: 0.7rem;
        padding: 0.72rem 0.95rem;
        font-weight: 700;
        color: #05392f;
        background: linear-gradient(130deg, #3dd8c5, #1aa793);
        cursor: pointer;
    }

    .logout-link {
        display: inline-block;
        margin-top: 1rem;
        color: #9fded7;
    }

    .error {
        min-height: 1.2rem;
        color: #fca5a5;
        margin-top: 0.4rem;
    }
</style>
